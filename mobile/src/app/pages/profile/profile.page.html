<!-- src/app/pages/my-books/profile.page.html -->
<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start"><ion-menu-button></ion-menu-button></ion-buttons>
    <ion-title>Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="profile-content">
  <div class="card">
    <!-- HEADER -->
    <div class="header">
      <div class="avatar-wrap">
        <ion-avatar class="avatar" (click)="openAvatarModal()">
          <img [src]="avatarUrl()" alt="avatar" loading="lazy" />
        </ion-avatar>

        <!-- Bot√≥n flotante para cambiar -->
        <button class="avatar-edit-btn" type="button" (click)="pickAvatar(fileInput); $event.stopPropagation()">
          <ion-icon name="camera-outline"></ion-icon>
        </button>

        <!-- input de archivo oculto (fallback) -->
        <input #fileInput type="file" accept="image/*" capture="environment" class="visually-hidden"
          (change)="onAvatarSelected($event)" />
      </div>

      <div class="id">
        <h2>{{ fullName() || user()?.nombres }}</h2>
        <p class="email">{{ user()?.email }}</p>
        <p class="user">@{{ user()?.nombre_usuario }}</p>
      </div>
    </div>

    <!-- M√âTRICAS -->
    <!-- M√âTRICAS -->
    <div class="metrics">
      <div class="metric">
        <div class="v">{{ metrics().libros }}</div>
        <div class="k">Libros</div>
      </div>

      <div class="metric">
        <div class="v">{{ metrics().intercambios }}</div>
        <div class="k">Intercambios</div>
      </div>

      <!-- üëá Nueva versi√≥n clickeable de calificaci√≥n -->
      <div class="metric rating-metric" (click)="goMyRatings()">
        <div class="stars">
          <ion-icon *ngFor="let s of stars()" [name]="s"></ion-icon>
        </div>
        <div class="k">Mis calificaciones</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button [class.active]="tab()==='info'" (click)="setTab('info')">Informaci√≥n</button>
      <button [class.active]="tab()==='history'" (click)="setTab('history')">Historial</button>
      <button [class.active]="tab()==='settings'" (click)="setTab('settings')">Ajustes</button>
    </div>

    <!-- INFO -->
    <div class="tab-pane" *ngIf="tab()==='info'">
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px">
        <ion-button size="small" fill="outline" (click)="toggleEdit()">
          {{ editMode() ? 'Cancelar' : 'Editar' }}
        </ion-button>
        <ion-button size="small" color="primary" (click)="save()" *ngIf="editMode()">Guardar</ion-button>
      </div>

      <ion-list lines="none" *ngIf="!editMode()">
        <ion-item><ion-label>
            <h3>RUT</h3>
            <p>{{ user()?.rut || '‚Äî' }}</p>
          </ion-label></ion-item>
        <ion-item><ion-label>
            <h3>Nombre</h3>
            <p>{{ fullName() || user()?.nombres }}</p>
          </ion-label></ion-item>
        <ion-item><ion-label>
            <h3>Correo</h3>
            <p>{{ user()?.email }}</p>
          </ion-label></ion-item>
        <ion-item>
          <ion-label>
            <h3>Direcci√≥n</h3>
            <p>{{ user()?.direccion_completa || ((user()?.direccion || '') + ' ' + (user()?.numeracion || '')) || '‚Äî' }}
            </p>
          </ion-label>
        </ion-item>
        <ion-item><ion-label>
            <h3>Tel√©fono</h3>
            <p>{{ user()?.telefono || '‚Äî' }}</p>
          </ion-label></ion-item>
      </ion-list>

      <form [formGroup]="form" *ngIf="editMode()">
        <ion-list lines="full">
          <ion-item><ion-input label="Nombres" labelPlacement="stacked"
              formControlName="nombres"></ion-input></ion-item>
          <ion-item><ion-input label="Apellido paterno" labelPlacement="stacked"
              formControlName="apellido_paterno"></ion-input></ion-item>
          <ion-item><ion-input label="Apellido materno" labelPlacement="stacked"
              formControlName="apellido_materno"></ion-input></ion-item>
          <ion-item><ion-input label="Tel√©fono" labelPlacement="stacked"
              formControlName="telefono"></ion-input></ion-item>
          <ion-item><ion-input label="Direcci√≥n" labelPlacement="stacked"
              formControlName="direccion"></ion-input></ion-item>
          <ion-item><ion-input label="Numeraci√≥n" labelPlacement="stacked"
              formControlName="numeracion"></ion-input></ion-item>
        </ion-list>
      </form>
    </div>

    <!-- HISTORIAL -->
    <div class="tab-pane" *ngIf="tab()==='history'">
      <ion-list *ngIf="history().length; else noHist" lines="full">
        <ion-item *ngFor="let it of history()">
          <ion-label>
            <h3>{{ it.titulo }}</h3>
            <p>{{ it.estado }} ¬∑ {{ it.fecha }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <ng-template #noHist>
        <p class="muted">Sin intercambios por ahora.</p>
      </ng-template>
    </div>

    <!-- AJUSTES -->
    <div class="tab-pane" *ngIf="tab()==='settings'">
      <ion-button expand="block" fill="outline" (click)="togglePwd()">
        {{ showPwd() ? 'Ocultar cambio de contrase√±a' : 'Cambiar contrase√±a' }}
      </ion-button>

      <form *ngIf="showPwd()" [formGroup]="pwdForm" (ngSubmit)="submitPwd()">
        <ion-list lines="full" class="mt">
          <ion-item>
            <ion-input type="password" label="Contrase√±a actual" labelPlacement="stacked" formControlName="current"
              autocomplete="current-password">
            </ion-input>
          </ion-item>

          <ion-item class="mt">
            <ion-input type="password" label="Nueva contrase√±a" labelPlacement="stacked" formControlName="password"
              autocomplete="new-password">
            </ion-input>
          </ion-item>
          <ion-note color="medium" class="note">
            M√≠nimo 8, con may√∫scula, min√∫scula, n√∫mero y s√≠mbolo.
          </ion-note>
          <ion-note color="danger" *ngIf="pwdForm.get('password')?.touched && pwdForm.get('password')?.invalid"
            class="note">
            La nueva contrase√±a no cumple los requisitos.
          </ion-note>

          <ion-item class="mt">
            <ion-input type="password" label="Confirmar nueva contrase√±a" labelPlacement="stacked"
              formControlName="confirm" autocomplete="new-password">
            </ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="pwdForm.touched && pwdForm.errors?.['mismatch']" class="note">
            Las contrase√±as no coinciden.
          </ion-note>

          <ion-button expand="block" class="mt" type="submit" [disabled]="pwdForm.invalid || busyPwd">
            {{ busyPwd ? 'Guardando...' : 'Guardar' }}
          </ion-button>
        </ion-list>
      </form>

      <ion-button class="mt" expand="block" color="danger" (click)="doLogout()">Cerrar sesi√≥n</ion-button>
    </div>

    <!-- MODAL: ver avatar en grande + cambiar -->
    <ion-modal [isOpen]="avatarModal()" (didDismiss)="closeAvatarModal()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Foto de perfil</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeAvatarModal()">Cerrar</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="avatar-modal">
          <img [src]="avatarUrl()" alt="avatar grande" />
          <div class="actions">
            <ion-button (click)="pickAvatar(fileInputModal)" fill="solid">
              <ion-icon slot="start" name="camera-outline"></ion-icon>
              Cambiar imagen
            </ion-button>
            <input #fileInputModal type="file" accept="image/*" capture="environment" class="visually-hidden"
              (change)="onAvatarSelected($event)" />
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>
  </div>
</ion-content>