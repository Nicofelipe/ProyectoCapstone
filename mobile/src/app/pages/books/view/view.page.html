<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{ book?.titulo || 'Publicaci√≥n' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content pullingText="Desliza para actualizar" refreshingSpinner="crescent"
      refreshingText="Actualizando‚Ä¶"></ion-refresher-content>
  </ion-refresher>

  <ng-container *ngIf="book as b; else loadingTpl">
    <section class="hero">
      <div #gallery class="snap-gallery" (scroll)="onScroll(gallery)">
        <img *ngFor="let url of imgUrls; let i = index; trackBy: trackByIndex" [src]="url"
          [alt]="b.titulo || 'Imagen del libro'" (click)="openImageViewer(i)" (error)="onImgError($event)"
          class="hero-img" />
      </div>

      <ion-fab *ngIf="me && book && !isMine()" class="fav-in-hero">
        <ion-fab-button size="small" class="fav-btn" [class.fav-on]="isFav"
          (click)="toggleFav(); $event.stopPropagation()" [disabled]="isFavBusy || !book?.disponible"
          aria-label="Favorito">
          <ion-icon [name]="isFav ? 'heart' : 'heart-outline'"></ion-icon>
        </ion-fab-button>
      </ion-fab>

      <div class="dots" *ngIf="imgUrls.length > 1">
        <button type="button" *ngFor="let _ of imgUrls; let i = index; trackBy: trackByIndex"
          [class.active]="i === currentIndex" (click)="scrollTo(i, gallery)"
          [attr.aria-label]="'Ir a imagen ' + (i + 1)"></button>
      </div>
    </section>

    <section class="paper">
      <h1 class="title">{{ b.titulo }}</h1>
      <p class="subtitle">de {{ b.autor || '‚Äî' }}</p>

      <div class="owner">
        <button class="owner-link" type="button" [disabled]="!b.owner_id" (click)="goOwner(b.owner_id)"
          [attr.aria-label]="'Ver perfil de ' + (owner?.nombre_usuario || b.owner_nombre || '')">
          <strong class="owner-name">
            @{{ owner?.nombre_usuario || b.owner_nombre || '‚Äî' }}
          </strong>
        </button>

        <span class="owner-rating" *ngIf="owner?.rating_avg != null">
          ‚Ä¢ ‚òÖ {{ owner?.rating_avg | number:'1.1-1' }} ({{ owner?.rating_count }})
        </span>

        <span class="owner-note" *ngIf="isMine()">‚Ä¢ Es tu libro</span>
        <span class="owner-note" *ngIf="!b.disponible && !isMine()">‚Ä¢ No disponible</span>
      </div>

      <div class="meta-tags-grid">
        <div class="meta-item">
          <ion-icon name="sparkles-outline" color="primary"></ion-icon>
          <ion-label>
            <span class="small-title">Estado</span>
            <strong>{{ b.estado || '‚Äî' }}</strong>
          </ion-label>
        </div>

        <div class="meta-item" *ngIf="b.genero_nombre || b.genero">
          <ion-icon name="book-outline" color="primary"></ion-icon>
          <ion-label>
            <span class="small-title">G√©nero</span>
            <strong>{{ b.genero_nombre || b.genero }}</strong>
          </ion-label>
        </div>

        <div class="meta-item" *ngIf="b.tipo_tapa">
          <ion-icon name="layers-outline" color="primary"></ion-icon>
          <ion-label>
            <span class="small-title">Formato</span>
            <strong>{{ b.tipo_tapa }}</strong>
          </ion-label>
        </div>

        <div class="meta-item">
          <ion-icon name="calendar-outline" color="primary"></ion-icon>
          <ion-label>
            <span class="small-title">Publicado</span>
            <strong>{{ b.fecha_subida | date:'mediumDate' }}</strong>
          </ion-label>
        </div>
      </div>

      <div class="desc-section" *ngIf="b.descripcion">
        <h3>Descripci√≥n</h3>
        <p class="desc" [innerText]="b.descripcion"></p>
      </div>
    </section>

    <div class="cta">
      <ng-container *ngIf="isMine(); else notMine">
        <ion-button expand="block" color="medium" [disabled]="true">
          LIBRO EN PROPIEDAD
        </ion-button>

        <div class="incoming-box" *ngIf="incoming && incomingIsForMyBook">
          <p class="incoming-text">
            <ng-container *ngIf="incomingEstadoCanon === 'pendiente'; else acceptedOwnerMsg">
              <strong>{{ incomingUserName || 'Un usuario' }}</strong>
              ofreci√≥
              <strong>{{ incomingOfferedTitle || 'un libro' }}</strong>
              por tu libro
              <strong>{{ book?.titulo }}</strong>.
            </ng-container>
            <ng-template #acceptedOwnerMsg>
              Intercambio <strong>aceptado</strong>:
              <strong>{{ incomingUserName || 'Un usuario' }}</strong>
              intercambia
              <strong>{{ incomingOfferedTitle || 'un libro' }}</strong>
              por este libro.
            </ng-template>
          </p>

          <div class="incoming-actions">
            <ion-button size="small" fill="clear" (click)="goRequests()">
              Ver solicitud
            </ion-button>
            <ion-button *ngIf="incomingEstadoCanon === 'pendiente'" size="small" color="success"
              (click)="quickAccept()">
              Aceptar
            </ion-button>
            <ion-button *ngIf="incomingEstadoCanon === 'pendiente'" size="small" color="danger" fill="outline"
              (click)="quickReject()">
              Rechazar
            </ion-button>
          </div>
        </div>

        <ion-button expand="block" fill="outline" *ngIf="currentMyBook?.has_requests" (click)="goRequests()">
          Ver solicitudes para este libro
        </ion-button>
      </ng-container>

      <ng-template #notMine>
        <ion-button expand="block" color="medium" [disabled]="true" *ngIf="!b.disponible">
          No disponible
        </ion-button>

        <ion-button expand="block" color="primary" *ngIf="b.disponible && !me" (click)="goLogin()">
          Iniciar sesi√≥n para solicitar
        </ion-button>

        <ng-container *ngIf="b.disponible && me">
          <!-- üí° CASO CLAVE:
           Soy el usuario B viendo el libro N del usuario A,
           y ya hay una SOLICITUD que usa este libro como "libro del otro" conmigo -->
          <div class="incoming-box" *ngIf="incoming && incomingIsForOtherBook; else normalRequestBlock">
            <p class="incoming-text">
              <ng-container *ngIf="incomingEstadoCanon === 'pendiente'; else acceptedOtherMsg">
                <strong>{{ incomingUserName || 'Un usuario' }}</strong>
                te ofreci√≥ este libro
                <strong>{{ incomingOfferedTitle || book?.titulo }}</strong>
                por tu libro
                <strong>{{ incomingMyBookTitle || 'uno de tus libros' }}</strong>.
              </ng-container>
              <ng-template #acceptedOtherMsg>
                Este libro forma parte de un intercambio
                <strong>aceptado contigo</strong>
                por tu libro
                <strong>{{ incomingMyBookTitle || 'uno de tus libros' }}</strong>.
              </ng-template>
            </p>

            <div class="incoming-actions">
              <ion-button size="small" fill="clear" (click)="goRequests()">
                Ver solicitud
              </ion-button>
              <ion-button *ngIf="incomingEstadoCanon === 'pendiente'" size="small" color="success"
                (click)="quickAccept()">
                Aceptar
              </ion-button>
              <ion-button *ngIf="incomingEstadoCanon === 'pendiente'" size="small" color="danger" fill="outline"
                (click)="quickReject()">
                Rechazar
              </ion-button>
            </div>
          </div>

          <!-- CASO NORMAL: no hay solicitud directa conmigo usando este libro -->
          <ng-template #normalRequestBlock>

            <!-- Si el libro est√° marcado como en negociaci√≥n pero NO es conmigo,
             que se muestre como no disponible para terceros -->
            <ion-button expand="block" color="medium" [disabled]="true"
              *ngIf="b.en_negociacion && !incomingIsForOtherBook; else guardBlock">
              Libro en intercambio, no disponible
            </ion-button>

            <ng-template #guardBlock>
              <ion-button expand="block" color="medium" [disabled]="true" *ngIf="guard && !guard.allowed">
                {{ guard.reason || 'No puedes solicitar este libro' }}
              </ion-button>

              <ion-button expand="block" fill="outline"
                *ngIf="guard && !guard.allowed && guard.reason === 'Ya tienes una solicitud pendiente/aceptada'"
                (click)="goRequests()">
                Ver mis solicitudes
              </ion-button>

              <ion-button expand="block" color="medium" [disabled]="true"
                *ngIf="guard?.allowed && !hasOfferableBooks()">
                No tienes libros disponibles para intercambiar
              </ion-button>

              <ion-button expand="block" color="primary" *ngIf="guard?.allowed && hasOfferableBooks()"
                (click)="openOffer()">
                Proponer intercambio
              </ion-button>
            </ng-template>
          </ng-template>
        </ng-container>
      </ng-template>
    </div>

    <ion-modal [isOpen]="offerOpen" (didDismiss)="closeOffer()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Elige un libro para ofrecer</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeOffer()">Cerrar</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content>
          <ion-radio-group [(ngModel)]="selectedId">
            <ion-list inset="true" class="offer-list">
              <ion-item *ngFor="let m of myAvailBooks; trackBy: trackByBookId" class="offer-item"
                [class.offer-item-selected]="selectedId === m.id" lines="none">
                <ion-radio slot="start" [value]="m.id"></ion-radio>

                <ion-avatar slot="start" class="thumb">
                  <img [src]="m.first_image || FALLBACK" (error)="onImgError($event)" />
                </ion-avatar>

                <ion-label>
                  <h3>{{ m.titulo }}</h3>
                  <p class="muted">de {{ m.autor }} ‚Ä¢ {{ m.estado }}</p>
                </ion-label>
              </ion-item>

              <ion-item *ngIf="!myAvailBooks.length" lines="none">
                <ion-label class="muted">
                  No tienes libros disponibles.
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-radio-group>

          <div class="cta-in-modal">
            <ion-note class="muted">
              Libro seleccionado: {{ selectedId ? '1' : '0' }}/1
            </ion-note>
            <ion-button expand="block" (click)="sendOffer()" [disabled]="sending || !selectedId">
              Enviar solicitud
              <ion-spinner slot="end" *ngIf="sending"></ion-spinner>
            </ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <ion-modal [isOpen]="imageViewerOpen" (didDismiss)="closeImageViewer()" cssClass="image-viewer-modal">
      <ng-template>
        <ion-header translucent="true">
          <ion-toolbar>
            <ion-buttons slot="start">
              <ion-button (click)="closeImageViewer()">
                <ion-icon slot="icon-only" name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
            <ion-title>Im√°genes del libro</ion-title>
          </ion-toolbar>
        </ion-header>

        <ion-content [fullscreen]="true" class="image-viewer-content">
          <div #viewerGallery class="viewer-gallery" (scroll)="onScroll(viewerGallery)">
            <img *ngFor="let url of imgUrls; let i = index; trackBy: trackByIndex" [src]="url"
              [alt]="book?.titulo || 'Imagen del libro'" (error)="onImgError($event)" />
          </div>

          <div class="viewer-dots" *ngIf="imgUrls.length > 1">
            <button type="button" *ngFor="let _ of imgUrls; let i = index; trackBy: trackByIndex"
              [class.active]="i === currentIndex" (click)="scrollTo(i, viewerGallery)"
              [attr.aria-label]="'Ir a imagen ' + (i + 1)"></button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

  </ng-container>

  <ng-template #loadingTpl>
    <div class="pad">Cargando‚Ä¶</div>
  </ng-template>
</ion-content>