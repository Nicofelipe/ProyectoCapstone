<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-title>{{ book?.titulo || 'Publicación' }}</ion-title>

  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ng-container *ngIf="book as b; else loadingTpl">

    <!-- ===== Hero / Carrusel ===== -->
    <section class="hero">
      <div #gallery class="snap-gallery" (scroll)="onScroll(gallery)">
        <img *ngFor="let url of imgUrls; trackBy: trackByIndex" [src]="url" [alt]="b.titulo || 'Imagen del libro'"
          (error)="onImgError($event)" />
      </div>


      <!-- ❤️ FAB flotante estable -->
      <ion-fab *ngIf="me && book && !isMine()" class="fav-in-hero">
        <ion-fab-button size="small" class="fav-btn" [class.fav-on]="isFav"
          (click)="toggleFav(); $event.stopPropagation()" [disabled]="isFavBusy || !book?.disponible"
          aria-label="Favorito">
          <ion-icon [name]="isFav ? 'heart' : 'heart-outline'"></ion-icon>
        </ion-fab-button>
      </ion-fab>



      <!-- dots -->
      <div class="dots" *ngIf="imgUrls.length > 1">
        <button type="button" *ngFor="let _ of imgUrls; let i = index; trackBy: trackByIndex"
          [class.active]="i === currentIndex" (click)="scrollTo(i, gallery)"
          [attr.aria-label]="'Ir a imagen ' + (i + 1)"></button>
      </div>
    </section>

    <!-- ===== Tarjeta “papel” ===== -->
    <section class="paper">
      <h1 class="title">{{ b.titulo }}</h1>
      <p class="subtitle">de {{ b.autor || '—' }}</p>
      <p class="meta">Estado: {{ b.estado || '—' }} • {{ b.fecha_subida | date:'mediumDate' }}</p>

      <div class="owner">
        <button class="owner-link" type="button" [disabled]="!b.owner_id" (click)="goOwner(b.owner_id)"
          [attr.aria-label]="'Ver perfil de ' + (owner?.nombre_usuario || b.owner_nombre || '')">
          <strong class="owner-name">@{{ owner?.nombre_usuario || b.owner_nombre || '—' }}</strong>
        </button>

        <span class="owner-rating" *ngIf="owner?.rating_avg != null">
          • ★ {{ owner?.rating_avg | number:'1.1-1' }} ({{ owner?.rating_count }})
        </span>
        <span class="owner-note" *ngIf="isMine()">• este libro es de tu propiedad</span>
        <span class="owner-note" *ngIf="!b.disponible && !isMine()">• no disponible</span>
      </div>

      <p class="desc" *ngIf="b.descripcion" [innerText]="b.descripcion"></p>
    </section>

    <!-- ===== CTA dinámica (pegajosa) ===== -->
    <div class="cta">
      <ion-button expand="block" color="medium" [disabled]="true" *ngIf="isMine()">
        LIBRO EN PROPIEDAD
      </ion-button>

      <ion-button expand="block" color="medium" [disabled]="true" *ngIf="!isMine() && !b.disponible">
        No disponible
      </ion-button>

      <ion-button expand="block" color="primary" *ngIf="!me" (click)="goLogin()">
        Iniciar sesión para solicitar
      </ion-button>

      <ng-container *ngIf="me && !isMine() && b.disponible && alreadySent">
        <ion-button expand="block" color="success" [disabled]="true">
          Solicitud enviada
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="goRequests()">
          Ver solicitudes
        </ion-button>
      </ng-container>

      <ion-button expand="block" color="medium" [disabled]="true"
        *ngIf="me && !isMine() && b.disponible && !alreadySent && !myAvailBooks.length">
        No tienes libros para intercambiar
      </ion-button>

      <ion-button expand="block" color="primary"
        *ngIf="me && !isMine() && b.disponible && !alreadySent && myAvailBooks.length" (click)="openOffer()">
        Proponer intercambio
      </ion-button>
    </div>

    <!-- ===== MODAL selección 1..3 libros (igual que antes) ===== -->
    <ion-modal [isOpen]="offerOpen" (didDismiss)="closeOffer()">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Elige 1 a 3 libros</ion-title>
            <ion-buttons slot="end"><ion-button (click)="closeOffer()">Cerrar</ion-button></ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-list inset="true">
            <ion-item *ngFor="let m of myAvailBooks; trackBy: trackByBookId">
              <ion-checkbox slot="start" [checked]="selectedIds.includes(m.id)" (ionChange)="toggleSelect(m.id)"
                [disabled]="isOccupied(m.id) || (!selectedIds.includes(m.id) && selectedIds.length >= 3)">
              </ion-checkbox>
              <ion-avatar slot="start" class="thumb">
                <img [src]="m.first_image || FALLBACK" (error)="onImgError($event)" />
              </ion-avatar>
              <ion-label>
                <h3>{{ m.titulo }}</h3>
                <p class="muted">de {{ m.autor }} • {{ m.estado }}</p>
              </ion-label>
              <ion-note slot="end" color="medium" *ngIf="isOccupied(m.id)">En otra solicitud</ion-note>
            </ion-item>

            <ion-item *ngIf="!myAvailBooks.length">
              <ion-label class="muted">No tienes libros disponibles.</ion-label>
            </ion-item>
          </ion-list>

          <div class="cta-in-modal">
            <ion-note class="muted">Seleccionados: {{ selectedIds.length }}/3</ion-note>
            <ion-button expand="block" (click)="sendOffer()"
              [disabled]="sending || !selectedIds.length || selectedIds.length > 3">
              Enviar solicitud
              <ion-spinner slot="end" *ngIf="sending"></ion-spinner>
            </ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="pad">Cargando…</div>
  </ng-template>
</ion-content>