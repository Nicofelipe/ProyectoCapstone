<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>

    <ion-title>Cambioteca</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="buscar()">
        <ion-icon name="search-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="home-content">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content pullingText="Desliza para actualizar" refreshingSpinner="crescent"
      refreshingText="Actualizando…">
    </ion-refresher-content>
  </ion-refresher>

  <section class="hero">
    <img src="assets/icon/cambiotecasimple.png" alt="Logo Cambioteca" loading="lazy" />
    <h2>Intercambia libros fácil y rápido</h2>
    <p>Descubre, intercambia y da una segunda vida a tus libros favoritos.</p>

    <ion-searchbar [(ngModel)]="q" placeholder="Buscar por título o autor" (ionChange)="buscar()" [debounce]="400">
    </ion-searchbar>
  </section>

  <ng-container *ngIf="!isSearching">
    <section class="block">
      <div class="block-title">
        <h3>Últimos agregados</h3>
        <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
      </div>

      <div *ngIf="loading; else ultimosReal">
        <swiper-container slides-per-view="1.1" space-between="12" centered-slides="true" style="display:block">
          <swiper-slide *ngFor="let _ of [0,1,2,3]">
            <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
          </swiper-slide>
        </swiper-container>
      </div>

      <ng-template #ultimosReal>
        <swiper-container slides-per-view="1.1" space-between="12" centered-slides="true" style="display:block"
          *ngIf="ultimos?.length; else noUltimos">
          <swiper-slide *ngFor="let b of ultimos; trackBy: trackByLibro">
            <ion-card (click)="goBook(b.id)" style="cursor:pointer">
              <figure class="thumb">
                <img [src]="cover(b)" [alt]="b.titulo || 'Portada'" loading="lazy" (error)="onImgError($event)" />
                <ion-badge *ngIf="b.public_disponible === false" class="badge-estado" color="medium">
                  En negociación
                </ion-badge>
              </figure>

              <ion-card-header>
                <ion-card-title>{{ b.titulo }}</ion-card-title>
                <ion-card-subtitle>{{ b.autor }}</ion-card-subtitle>
              </ion-card-header>

              <ion-card-content>
                <div class="chips">
                  <ion-chip *ngIf="b.owner_nombre" color="medium" outline="true"
                    (click)="$event.stopPropagation(); goUser(b.owner_id)" style="cursor:pointer">
                    Subido por: {{ isMe(b.owner_id) ? 'Tú' : '@' + b.owner_nombre }}
                  </ion-chip>
                </div>

                <p class="fecha-subida">
                  Publicado: {{ b.fecha_subida | date:'short' }}
                </p>
              </ion-card-content>
            </ion-card>
          </swiper-slide>
        </swiper-container>

        <ng-template #noUltimos>
          <ion-text color="medium">
            <p style="text-align:center;">No hay libros recientes aún.</p>
          </ion-text>
        </ng-template>
      </ng-template>
    </section>

    <section class="block">
      <div class="block-title">
        <h3>Explorar por Género</h3>
        <ion-spinner *ngIf="loadingGenero" name="crescent"></ion-spinner>
      </div>

      <div class="genre-filters" *ngIf="generos.length > 0">
        <swiper-container slides-per-view="auto" space-between="8" style="padding: 0 10px;">

          <swiper-slide *ngFor="let g of generos; trackBy: trackByGenero">
            <ion-chip [outline]="generoSeleccionado !== g.id_genero" (click)="seleccionarGenero(g.id_genero)">
              {{ g.nombre }}
            </ion-chip>
          </swiper-slide>
        </swiper-container>
      </div>

      <div *ngIf="loadingGenero; else generoReal">
        <swiper-container slides-per-view="1.1" space-between="12" centered-slides="true" style="display:block">
          <swiper-slide *ngFor="let _ of [0,1,2]">
            <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
          </swiper-slide>
        </swiper-container>
      </div>

      <ng-template #generoReal>
        <swiper-container slides-per-view="1.1" space-between="12" centered-slides="true" style="display:block"
          *ngIf="librosPorGenero?.length; else noLibrosGenero">
          <swiper-slide *ngFor="let b of librosPorGenero; trackBy: trackByLibro">
            <ion-card (click)="goBook(b.id)" style="cursor:pointer">
              <figure class="thumb">
                <img [src]="cover(b)" [alt]="b.titulo || 'Portada'" loading="lazy" (error)="onImgError($event)" />
              </figure>
              <ion-card-header>
                <ion-card-title>{{ b.titulo }}</ion-card-title>
                <ion-card-subtitle>{{ b.autor }}</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <div class="chips">
                  <ion-chip *ngIf="b.owner_nombre" color="medium" outline="true"
                    (click)="$event.stopPropagation(); goUser(b.owner_id)" style="cursor:pointer">
                    Subido por: {{ isMe(b.owner_id) ? 'Tú' : '@' + b.owner_nombre }}
                  </ion-chip>
                </div>
                <p class="fecha-subida">
                  Publicado: {{ b.fecha_subida | date:'short' }}
                </p>
              </ion-card-content>
            </ion-card>
          </swiper-slide>
        </swiper-container>

        <ng-template #noLibrosGenero>
          <ion-text color="medium" *ngIf="!loadingGenero && generoSeleccionado !== null">
            <p style="text-align:center;">No hay libros disponibles en este género.</p>
          </ion-text>
        </ng-template>
      </ng-template>
    </section>


    <section class="block">
      <div class="block-title">
        <h3>Sobre Cambioteca</h3>
      </div>
      <p style="max-width:820px;margin:0 auto;">
        Cambioteca es una herramienta pensada para la circulación de esos libros olvidados
        y para fomentar la lectura compartiendo saberes. Aquí puedes descubrir títulos,
        intercambiarlos de forma segura y darles una segunda vida en tu barrio.
      </p>
      <div class="center" style="margin-top:10px; gap:8px; flex-wrap: wrap;">
        <ion-chip color="success" outline="true">Reutiliza y comparte</ion-chip>
        <ion-chip color="primary" outline="true">Comunidad lectora</ion-chip>
        <ion-chip color="tertiary" outline="true">Intercambios simples</ion-chip>
      </div>
    </section>
  </ng-container>
  <section class="block" *ngIf="isSearching">
    <div class="block-title">
      <h3>Resultados de "{{ q }}"</h3>
      <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
    </div>

    <div *ngIf="loading; else resultadosReal">
      <div class="search-results-grid">
        <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
        <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
        <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
        <ng-container *ngTemplateOutlet="skeletonCard"></ng-container>
      </div>
    </div>

    <ng-template #resultadosReal>
      <div class="search-results-grid" *ngIf="ultimos?.length; else noResultados">

        <ion-card *ngFor="let b of ultimos; trackBy: trackByLibro" (click)="goBook(b.id)" style="cursor:pointer">

          <figure class="thumb">
            <img [src]="cover(b)" [alt]="b.titulo || 'Portada'" loading="lazy" (error)="onImgError($event)" />
            <ion-badge *ngIf="b.public_disponible === false" class="badge-estado" color="medium">
              En negociación
            </ion-badge>
          </figure>

          <ion-card-header>
            <ion-card-title>{{ b.titulo }}</ion-card-title>
            <ion-card-subtitle>{{ b.autor }}</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <div class="chips">

              <ion-chip *ngIf="b.owner_nombre" color="medium" outline="true"
                (click)="$event.stopPropagation(); goUser(b.owner_id)" style="cursor:pointer">
                Subido por: {{ isMe(b.owner_id) ? 'Tú' : '@' + b.owner_nombre }}
              </ion-chip>
            </div>
            <p class="fecha-subida">
              Publicado: {{ b.fecha_subida | date:'short' }}
            </p>
          </ion-card-content>

        </ion-card>
      </div>
    </ng-template>

    <ng-template #noResultados>
      <ion-text color="medium" *ngIf="!loading">
        <p style="text-align:center;">No se encontraron libros para "{{ q }}".</p>
      </ion-text>
    </ng-template>
  </section>
  <div style="height:24px"></div>

  <ng-template #skeletonCard>
    <ion-card class="skeleton-card">
      <div class="skel-cover"></div>
      <ion-card-header>
        <ion-skeleton-text animated style="width:70%;height:18px;margin:8px auto;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width:40%;height:14px;margin:6px auto 0;"></ion-skeleton-text>
      </ion-card-header>
      <ion-card-content>
        <div class="chips">
          <ion-skeleton-text animated style="width:120px;height:26px;border-radius:16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width:90px;height:26px;border-radius:16px;"></ion-skeleton-text>
        </div>
        <ion-skeleton-text animated style="width:60%;height:10px;margin:6px auto 0;"></ion-skeleton-text>
      </ion-card-content>
    </ion-card>
  </ng-template>
</ion-content>