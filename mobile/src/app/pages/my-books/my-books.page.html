<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start"><ion-menu-button></ion-menu-button></ion-buttons>
    <ion-title>Mis libros</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="filters-sticky">
    <ion-segment [value]="filter()" class="filter-segment" (ionChange)="onFilterChange($event)">
      <ion-segment-button value="disponibles">
        <ion-label>Disponibles</ion-label>
      </ion-segment-button>

      <ion-segment-button value="en-curso">
        <ion-label>En curso</ion-label>
      </ion-segment-button>

      <ion-segment-button value="no-disponibles">
        <ion-label>No disponibles</ion-label>
      </ion-segment-button>

      <ion-segment-button value="all">
        <ion-label>Todos</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>
  <ng-container *ngIf="!loading(); else loadingTpl">
    <ng-container *ngIf="filteredBooks().length; else empty">
      <ion-list [inset]="true">
        <a *ngFor="let b of filteredBooks(); trackBy: trackById" (click)="open(b)" class="book-card-link"
          [class.not-disponible]="!b.disponible" (mousedown)="onItemClick($event)">

          <div class="card-image-wrapper">

            <div class="top-badge" aria-hidden="true">
              <ion-icon name="person-circle-outline"></ion-icon>
              <span>Mi libro</span>
            </div>

            <img [ngSrc]="b.first_image || '/media/books/librodefecto.png'" [fill]="true" alt="portada"
              (error)="onImgError($event)" loading="lazy" />

            <span *ngIf="b.has_new_requests" class="dot" title="Nuevas solicitudes"></span>

            <div class="text-box">
              <h3 class="title">{{ b.titulo }}</h3>
              <p class="author">de {{ b.autor }}</p>

              <p class="meta-line">
                <span *ngIf="b.comuna_nombre">
                  <ion-icon name="location-outline"></ion-icon>
                  {{ b.comuna_nombre }}
                </span>
                <span *ngIf="b.comuna_nombre"> &bull; </span>
                <span>
                  <ion-icon name="calendar-outline"></ion-icon>
                  {{ b.fecha_subida | date:'dd MMM y' }}
                </span>
              </p>

              <div class="chips-container">
                <!-- Estado del flujo de intercambio / disponibilidad -->
                <ion-chip class="status-chip">
                  <ion-icon [name]="estadoIcon(b)"></ion-icon>
                  <ion-label>{{ estadoVisual(b) }}</ion-label>
                </ion-chip>

                <!-- Condición física del libro (como nuevo, usado, etc.) -->
                <ion-chip class="exchange-chip">
                  <ion-icon name="pricetag-outline"></ion-icon>
                  <ion-label>{{ b.estado }}</ion-label>
                </ion-chip>
              </div>
            </div>
          </div>
        </a>
      </ion-list>
    </ng-container>
  </ng-container>

  <ng-template #loadingTpl>
    <ion-list [inset]="true">
      <div class="book-card-link skeleton" *ngFor="let i of [1,2,3]">
        <div class="card-image-wrapper">
          <ion-skeleton-text [animated]="true" class="skeleton-image"></ion-skeleton-text>
          <div class="text-box">
            <h3 class="title"><ion-skeleton-text [animated]="true" style="width: 70%"></ion-skeleton-text></h3>
            <p class="author"><ion-skeleton-text [animated]="true" style="width: 40%"></ion-skeleton-text></p>
            <p class="meta-line"><ion-skeleton-text [animated]="true" style="width: 80%"></ion-skeleton-text></p>
            <div class="chips-container">
              <ion-skeleton-text [animated]="true"
                style="width: 110px; height: 28px; border-radius: 16px;"></ion-skeleton-text>
            </div>
          </div>
        </div>
      </div>
    </ion-list>
  </ng-template>

  <ng-template #empty>
    <section class="empty-wrap">
    </section>
  </ng-template>
</ion-content>